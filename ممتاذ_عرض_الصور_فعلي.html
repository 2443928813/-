
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <title>نظام إدارة البيانات - مع ملاحظات</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; }
    .login, .main { max-width: 600px; margin: 50px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; }
    input, select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f5f5f5; }
    .expired { background-color: #f8d7da; }
    .warning { background-color: #fff3cd; }
    .safe { background-color: #d4edda; }
    .hidden { display: none; }
    .note { background-color: #fff9c4; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
  
button:hover {
  opacity: 0.9;
}
</style>
</head>
<body>

<div class="login" id="loginBox">
  <h2>🔐 تسجيل الدخول</h2>
  <input type="text" id="username" placeholder="اسم المستخدم">
  <input type="password" id="password" placeholder="كلمة المرور">
  <button style="padding: 8px 16px; border: none; background-color: #007bff; color: white; border-radius: 8px; cursor: pointer;" onclick="login()">دخول</button>
  <p id="loginError" style="color: red;"></p>
</div>


<div class="main hidden" id="mainBox" style="max-width: 1100px; margin: 30px auto; background: white; padding: 25px; border-radius: 14px; box-shadow: 0 0 10px rgba(0,0,0,0.05); font-family: 'Cairo', sans-serif;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <h2 style="margin: 0 0 10px 0; font-size: 22px;">📋 نظام إدارة البيانات</h2>
    <button style="padding: 8px 16px; border: none; background-color: #007bff; color: white; border-radius: 8px; cursor: pointer;" onclick="logout()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: 0.3s;">
      اتفضل يباشا شرفتنا ❤️
    </button>
  </div>

  <h2>📋 نظام إدارة البيانات</h2>
  <p>مرحبًا، <span id="roleLabel"></span></p>
  
<label for="searchInput">🔍 بحث باسم العامل أو رقم الإقامة</label>
<input type="text" id="searchInput" oninput="filterTable()" style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:10px;">

<div class="note" id="userNote">جاري تحميل الملاحظات...</div>
    <div style="margin: 10px 0; padding: 10px; background: #eef; border-radius: 8px;">
      <strong>شرح الألوان:</strong><br>
      🔴 <span style="background:#f8d7da;padding:3px 8px;border-radius:5px;">أحمر</span> = أقل من 30 يوم<br>
      🟡 <span style="background:#fff3cd;padding:3px 8px;border-radius:5px;">أصفر</span> = من 31 إلى 60 يوم<br>
      🟢 <span style="background:#d4edda;padding:3px 8px;border-radius:5px;">أخضر</span> = أكثر من 60 يوم
    </div>

  
<input type="text" id="searchInput" oninput="filterTable()" placeholder="🔍 بحث باسم العامل أو رقم الإقامة" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ccc;border-radius:8px;">

<label>اختر النظام:</label>

  <select id="sheetSelector" onchange="loadData()">
    <option value="العمال">نظام العمال</option>
    <option value="السجلات">نظام السجلات</option>
    <option value="الأراضي">نظام إيجار الأراضي</option>
    <option value="اليوزر">نظام يوزر المؤسسات</option>
    <option value="المركبات">نظام المركبات</option>
  </select>

  <div id="messageBox" style="color: red; font-weight: bold;"></div>
  <table id="dataTable"></table>
</div>

<script>
const webAppURL = "https://script.google.com/macros/s/AKfycbzd1jmbC4fAreMId0U9n01z5_OLkJQW3DRzh1D273D8hPkl93Dp7Rw6b4WQTyWQgtt9uQ/exec";
let currentRole = "";
let currentUser = "";

function login() {
  const u = document.getElementById("username").value;
  const p = document.getElementById("password").value;
  const errorBox = document.getElementById("loginError");

  if (u === "admin" && p === "2311211") {
    currentRole = "admin";
  } else if (u === "faal" && p === "123") {
    currentRole = "viewer";
  } else {
    errorBox.textContent = "بيانات الدخول غير صحيحة";
    return;
  }

  currentUser = u;
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("mainBox").classList.remove("hidden");
  document.getElementById("roleLabel").textContent = currentRole === "admin" ? "أدمن (صلاحية كاملة)" : "مراجع (عرض فقط)";
  loadUserNote();
  loadData();
}

function loadUserNote() {
  fetch(`${webAppURL}?sheet=الملاحظات`)
    .then(res => res.json())
    .then(data => {
      let note = "لا توجد ملاحظات حالياً.";
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === currentUser) {
          note = data[i][1];
          break;
        }
      }
      document.getElementById("userNote").textContent = note;
    })
    .catch(() => {
      document.getElementById("userNote").textContent = "تعذر تحميل الملاحظات.";
    });
}

function loadData() {
  const sheet = document.getElementById("sheetSelector").value;
  const table = document.getElementById("dataTable");
  const messageBox = document.getElementById("messageBox");
  messageBox.textContent = "";
  table.innerHTML = "";

  if (currentRole === "viewer" && sheet === "اليوزر") {
    messageBox.textContent = "عفوا، هذا النظام مخصص للإدارة فقط";
    return;
  }

  fetch(`${webAppURL}?sheet=${sheet}`)
    .then(res => res.json())
    .then(data => renderTable(data, sheet));
}

function renderTable(data, sheetName) {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  if (!data || data.length === 0) {
    table.innerHTML = "<tr><td>لا توجد بيانات</td></tr>";
    return;
  }

  let header = "<tr>";
  data[0].forEach(h => header += `<th>${h}</th>`);
  if (currentRole === "admin") header += "<th>حذف</th>";
  header += "</tr>";
  table.innerHTML += header;

  const now = new Date();
  for (let i = 1; i < data.length; i++) {
    let row = "<tr>";
    data[i].forEach((cell, j) => {
      let cellClass = "";
      if (typeof cell === "string") {
        if (cell.trim() === "داخل المملكة") cellClass = "safe";
        if (cell.trim() === "خارج المملكة") cellClass = "expired";
      }
      if (sheetName === "العمال" || sheetName === "المركبات" || sheetName === "السجلات") {
        if (j > 2 && isDate(cell)) {
          const days = dateDiffInDays(now, new Date(cell));
          if (days <= 30) cellClass = "expired";
          else if (days <= 60) cellClass = "warning";
          else cellClass = "safe";
        }
      }
      
let displayCell = cell;
if (typeof cell === "string" && cell.startsWith("http") && (cell.includes(".jpg") || cell.includes(".png"))) {
  displayCell = `<img src="${cell}" alt="صورة" style="width:60px;height:60px;border-radius:8px;">`;
}
row += `<td class="${cellClass}">${displayCell}</td>`;

    });
    if (currentRole === "admin") {
      row += `<td><button style="padding: 8px 16px; border: none; background-color: #007bff; color: white; border-radius: 8px; cursor: pointer;" onclick="deleteRow(${i + 1})">🗑️</button></td>`;
    }
    row += "</tr>";
    table.innerHTML += row;
  }
}

function deleteRow(rowIndex) {
  const sheet = document.getElementById("sheetSelector").value;
  fetch(webAppURL + "?sheet=" + sheet + "&delete=" + rowIndex)
    .then(() => {
      alert("✅ تم حذف الصف بنجاح");
      loadData();
    });
}

function isDate(val) {
  return !isNaN(Date.parse(val));
}

function dateDiffInDays(a, b) {
  const _MS_PER_DAY = 1000 * 60 * 60 * 24;
  const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
  const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.floor((utc2 - utc1) / _MS_PER_DAY);
}

function logout() {
  currentRole = "";
  currentUser = "";
  document.getElementById("mainBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("loginError").textContent = "";
}

function filterTable() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#dataTable tr");
  let visible = 0;

  rows.forEach((row, index) => {
    if (index === 0) return;
    const cells = row.querySelectorAll("td");
    const text = Array.from(cells).map(td => td.textContent.toLowerCase()).join(" ");
    const show = input === "" || text.includes(input);
    row.style.display = show ? "" : "none";
    if (show) visible++;
  });
}

function calculateRemainingDays(dateStr) {
  const now = new Date();
  
  const cleanDateStr = dateStr.split("T")[0]; // extract "2028-05-24" from full ISO
  const target = new Date(cleanDateStr);

  const diffTime = target - now;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  if (isNaN(diffDays)) return "";
  return diffDays >= 0 ? `باقي ${diffDays} يوم` : `منتهي منذ ${Math.abs(diffDays)} يوم`;
}

function addRemainingDaysColumns() {
  const headers = document.querySelectorAll("#dataTable thead tr th");
  const rows = document.querySelectorAll("#dataTable tbody tr");

  const dateCols = ["تاريخ انتهاء الإقامة", "تاريخ انتهاء العقد", "تاريخ الانتهاء", "تاريخ انتهاء الاستمارة", "تاريخ انتهاء التأمين"];
  const headerMap = Array.from(headers).map(h => h.textContent.trim());

  dateCols.forEach(label => {
    const index = headerMap.indexOf(label);
    if (index >= 0) {
      const newHeader = document.createElement("th");
      newHeader.textContent = `الأيام المتبقية لـ ${label}`;
      headers[0].parentNode.appendChild(newHeader);

      rows.forEach(row => {
        const cell = row.children[index];
        const newCell = document.createElement("td");
        
      const cleanDate = cell.textContent.trim().split("T")[0]; // simplify the date shown
      cell.textContent = cleanDate;
      newCell.textContent = calculateRemainingDays(cleanDate);

        row.appendChild(newCell);
      });
    }
  });
}

window.addEventListener("load", () => {
  setTimeout(addRemainingDaysColumns, 300);
});

function simplifyDate(iso) {
  return iso.includes("T") ? iso.split("T")[0] : iso;
}

function daysLeftText(dateStr) {
  const today = new Date();
  const target = new Date(dateStr);
  const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
  if (isNaN(diff)) return "";
  return diff >= 0 ? `باقي ${diff} يوم` : `منتهي منذ ${Math.abs(diff)} يوم`;
}

function insertRemainingDays() {
  const table = document.getElementById("dataTable");
  if (!table) return;

  const headerRow = table.rows[0];
  const labelMap = {
    "تاريخ انتهاء الإقامة": "الأيام المتبقية للإقامة",
    "تاريخ انتهاء العقد": "الأيام المتبقية للعقد",
    "تاريخ الانتهاء": "الأيام المتبقية",
    "تاريخ انتهاء الاستمارة": "الأيام المتبقية للاستمارة",
    "تاريخ انتهاء التأمين": "الأيام المتبقية للتأمين"
  };

  const dateIndexes = {};

  for (let i = 0; i < headerRow.cells.length; i++) {
    const label = headerRow.cells[i].textContent.trim();
    if (labelMap[label]) {
      dateIndexes[i] = labelMap[label];
    }
  }

  // أضف الأعمدة الجديدة للعناوين
  Object.values(dateIndexes).forEach(label => {
    const th = document.createElement("th");
    th.textContent = label;
    headerRow.appendChild(th);
  });

  for (let i = 1; i < table.rows.length; i++) {
    const row = table.rows[i];
    Object.keys(dateIndexes).forEach(index => {
      const cell = row.cells[index];
      const raw = cell.textContent.trim();
      const simple = simplifyDate(raw);
      cell.textContent = simple;
      const td = document.createElement("td");
      td.textContent = daysLeftText(simple);
      row.appendChild(td);
    });
  }
}

window.addEventListener("load", () => {
  const observer = new MutationObserver(() => {
    const table = document.getElementById("dataTable");
    if (table && table.rows.length > 1) {
      observer.disconnect();
      insertRemainingDays();
    }
  });
  observer.observe(document.body, { childList: true, subtree: true });
});
</script>

</body>
</html>
