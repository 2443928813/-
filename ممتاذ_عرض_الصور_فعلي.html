
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù…Ø¹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; }
    .login, .main { max-width: 600px; margin: 50px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; }
    input, select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f5f5f5; }
    .expired { background-color: #f8d7da; }
    .warning { background-color: #fff3cd; }
    .safe { background-color: #d4edda; }
    .hidden { display: none; }
    .note { background-color: #fff9c4; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
  
button:hover {
  opacity: 0.9;
}
</style>
</head>
<body>

<div class="login" id="loginBox">
  <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button style="padding: 8px 16px; border: none; background-color: #007bff; color: white; border-radius: 8px; cursor: pointer;" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <p id="loginError" style="color: red;"></p>
</div>


<div class="main hidden" id="mainBox" style="max-width: 1100px; margin: 30px auto; background: white; padding: 25px; border-radius: 14px; box-shadow: 0 0 10px rgba(0,0,0,0.05); font-family: 'Cairo', sans-serif;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <h2 style="margin: 0 0 10px 0; font-size: 22px;">ğŸ“‹ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    <button style="padding: 8px 16px; border: none; background-color: #007bff; color: white; border-radius: 8px; cursor: pointer;" onclick="logout()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: 0.3s;">
      Ø§ØªÙØ¶Ù„ ÙŠØ¨Ø§Ø´Ø§ Ø´Ø±ÙØªÙ†Ø§ â¤ï¸
    </button>
  </div>

  <h2>ğŸ“‹ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
  <p>Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <span id="roleLabel"></span></p>
  
<label for="searchInput">ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</label>
<input type="text" id="searchInput" oninput="filterTable()" style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:10px;">

<div class="note" id="userNote">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...</div>
    <div style="margin: 10px 0; padding: 10px; background: #eef; border-radius: 8px;">
      <strong>Ø´Ø±Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù†:</strong><br>
      ğŸ”´ <span style="background:#f8d7da;padding:3px 8px;border-radius:5px;">Ø£Ø­Ù…Ø±</span> = Ø£Ù‚Ù„ Ù…Ù† 30 ÙŠÙˆÙ…<br>
      ğŸŸ¡ <span style="background:#fff3cd;padding:3px 8px;border-radius:5px;">Ø£ØµÙØ±</span> = Ù…Ù† 31 Ø¥Ù„Ù‰ 60 ÙŠÙˆÙ…<br>
      ğŸŸ¢ <span style="background:#d4edda;padding:3px 8px;border-radius:5px;">Ø£Ø®Ø¶Ø±</span> = Ø£ÙƒØ«Ø± Ù…Ù† 60 ÙŠÙˆÙ…
    </div>

  
<input type="text" id="searchInput" oninput="filterTable()" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ccc;border-radius:8px;">

<label>Ø§Ø®ØªØ± Ø§Ù„Ù†Ø¸Ø§Ù…:</label>

  <select id="sheetSelector" onchange="loadData()">
    <option value="Ø§Ù„Ø¹Ù…Ø§Ù„">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ø§Ù„</option>
    <option value="Ø§Ù„Ø³Ø¬Ù„Ø§Øª">Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª</option>
    <option value="Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ">Ù†Ø¸Ø§Ù… Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ</option>
    <option value="Ø§Ù„ÙŠÙˆØ²Ø±">Ù†Ø¸Ø§Ù… ÙŠÙˆØ²Ø± Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª</option>
    <option value="Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</option>
  </select>

  <div id="messageBox" style="color: red; font-weight: bold;"></div>
  <table id="dataTable"></table>
</div>

<script>
const webAppURL = "https://script.google.com/macros/s/AKfycbzd1jmbC4fAreMId0U9n01z5_OLkJQW3DRzh1D273D8hPkl93Dp7Rw6b4WQTyWQgtt9uQ/exec";
let currentRole = "";
let currentUser = "";

function login() {
  const u = document.getElementById("username").value;
  const p = document.getElementById("password").value;
  const errorBox = document.getElementById("loginError");

  if (u === "admin" && p === "2311211") {
    currentRole = "admin";
  } else if (u === "faal" && p === "123") {
    currentRole = "viewer";
  } else {
    errorBox.textContent = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    return;
  }

  currentUser = u;
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("mainBox").classList.remove("hidden");
  document.getElementById("roleLabel").textContent = currentRole === "admin" ? "Ø£Ø¯Ù…Ù† (ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§Ù…Ù„Ø©)" : "Ù…Ø±Ø§Ø¬Ø¹ (Ø¹Ø±Ø¶ ÙÙ‚Ø·)";
  loadUserNote();
  loadData();
}

function loadUserNote() {
  fetch(`${webAppURL}?sheet=Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª`)
    .then(res => res.json())
    .then(data => {
      let note = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.";
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === currentUser) {
          note = data[i][1];
          break;
        }
      }
      document.getElementById("userNote").textContent = note;
    })
    .catch(() => {
      document.getElementById("userNote").textContent = "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.";
    });
}

function loadData() {
  const sheet = document.getElementById("sheetSelector").value;
  const table = document.getElementById("dataTable");
  const messageBox = document.getElementById("messageBox");
  messageBox.textContent = "";
  table.innerHTML = "";

  if (currentRole === "viewer" && sheet === "Ø§Ù„ÙŠÙˆØ²Ø±") {
    messageBox.textContent = "Ø¹ÙÙˆØ§ØŒ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø®ØµØµ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·";
    return;
  }

  fetch(`${webAppURL}?sheet=${sheet}`)
    .then(res => res.json())
    .then(data => renderTable(data, sheet));
}

function renderTable(data, sheetName) {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  if (!data || data.length === 0) {
    table.innerHTML = "<tr><td>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
    return;
  }

  let header = "<tr>";
  data[0].forEach(h => header += `<th>${h}</th>`);
  if (currentRole === "admin") header += "<th>Ø­Ø°Ù</th>";
  header += "</tr>";
  table.innerHTML += header;

  const now = new Date();
  for (let i = 1; i < data.length; i++) {
    let row = "<tr>";
    data[i].forEach((cell, j) => {
      let cellClass = "";
      if (typeof cell === "string") {
        if (cell.trim() === "Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù…Ù„ÙƒØ©") cellClass = "safe";
        if (cell.trim() === "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù…Ù„ÙƒØ©") cellClass = "expired";
      }
      if (sheetName === "Ø§Ù„Ø¹Ù…Ø§Ù„" || sheetName === "Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª" || sheetName === "Ø§Ù„Ø³Ø¬Ù„Ø§Øª") {
        if (j > 2 && isDate(cell)) {
          const days = dateDiffInDays(now, new Date(cell));
          if (days <= 30) cellClass = "expired";
          else if (days <= 60) cellClass = "warning";
          else cellClass = "safe";
        }
      }
      
let displayCell = cell;
if (typeof cell === "string" && cell.startsWith("http") && (cell.includes(".jpg") || cell.includes(".png"))) {
  displayCell = `<img src="${cell}" alt="ØµÙˆØ±Ø©" style="width:60px;height:60px;border-radius:8px;">`;
}
row += `<td class="${cellClass}">${displayCell}</td>`;

    });
    if (currentRole === "admin") {
      row += `<td><button style="padding: 8px 16px; border: none; background-color: #007bff; color: white; border-radius: 8px; cursor: pointer;" onclick="deleteRow(${i + 1})">ğŸ—‘ï¸</button></td>`;
    }
    row += "</tr>";
    table.innerHTML += row;
  }
}

function deleteRow(rowIndex) {
  const sheet = document.getElementById("sheetSelector").value;
  fetch(webAppURL + "?sheet=" + sheet + "&delete=" + rowIndex)
    .then(() => {
      alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ Ø¨Ù†Ø¬Ø§Ø­");
      loadData();
    });
}

function isDate(val) {
  return !isNaN(Date.parse(val));
}

function dateDiffInDays(a, b) {
  const _MS_PER_DAY = 1000 * 60 * 60 * 24;
  const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
  const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.floor((utc2 - utc1) / _MS_PER_DAY);
}

function logout() {
  currentRole = "";
  currentUser = "";
  document.getElementById("mainBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("loginError").textContent = "";
}

function filterTable() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#dataTable tr");
  let visible = 0;

  rows.forEach((row, index) => {
    if (index === 0) return;
    const cells = row.querySelectorAll("td");
    const text = Array.from(cells).map(td => td.textContent.toLowerCase()).join(" ");
    const show = input === "" || text.includes(input);
    row.style.display = show ? "" : "none";
    if (show) visible++;
  });
}

function calculateRemainingDays(dateStr) {
  const now = new Date();
  
  const cleanDateStr = dateStr.split("T")[0]; // extract "2028-05-24" from full ISO
  const target = new Date(cleanDateStr);

  const diffTime = target - now;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  if (isNaN(diffDays)) return "";
  return diffDays >= 0 ? `Ø¨Ø§Ù‚ÙŠ ${diffDays} ÙŠÙˆÙ…` : `Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° ${Math.abs(diffDays)} ÙŠÙˆÙ…`;
}

function addRemainingDaysColumns() {
  const headers = document.querySelectorAll("#dataTable thead tr th");
  const rows = document.querySelectorAll("#dataTable tbody tr");

  const dateCols = ["ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†"];
  const headerMap = Array.from(headers).map(h => h.textContent.trim());

  dateCols.forEach(label => {
    const index = headerMap.indexOf(label);
    if (index >= 0) {
      const newHeader = document.createElement("th");
      newHeader.textContent = `Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù€ ${label}`;
      headers[0].parentNode.appendChild(newHeader);

      rows.forEach(row => {
        const cell = row.children[index];
        const newCell = document.createElement("td");
        
      const cleanDate = cell.textContent.trim().split("T")[0]; // simplify the date shown
      cell.textContent = cleanDate;
      newCell.textContent = calculateRemainingDays(cleanDate);

        row.appendChild(newCell);
      });
    }
  });
}

window.addEventListener("load", () => {
  setTimeout(addRemainingDaysColumns, 300);
});

function simplifyDate(iso) {
  return iso.includes("T") ? iso.split("T")[0] : iso;
}

function daysLeftText(dateStr) {
  const today = new Date();
  const target = new Date(dateStr);
  const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
  if (isNaN(diff)) return "";
  return diff >= 0 ? `Ø¨Ø§Ù‚ÙŠ ${diff} ÙŠÙˆÙ…` : `Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° ${Math.abs(diff)} ÙŠÙˆÙ…`;
}

function insertRemainingDays() {
  const table = document.getElementById("dataTable");
  if (!table) return;

  const headerRow = table.rows[0];
  const labelMap = {
    "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©": "Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©",
    "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯": "Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø¹Ù‚Ø¯",
    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": "Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©",
    "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©": "Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©",
    "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†": "Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„ØªØ£Ù…ÙŠÙ†"
  };

  const dateIndexes = {};

  for (let i = 0; i < headerRow.cells.length; i++) {
    const label = headerRow.cells[i].textContent.trim();
    if (labelMap[label]) {
      dateIndexes[i] = labelMap[label];
    }
  }

  // Ø£Ø¶Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
  Object.values(dateIndexes).forEach(label => {
    const th = document.createElement("th");
    th.textContent = label;
    headerRow.appendChild(th);
  });

  for (let i = 1; i < table.rows.length; i++) {
    const row = table.rows[i];
    Object.keys(dateIndexes).forEach(index => {
      const cell = row.cells[index];
      const raw = cell.textContent.trim();
      const simple = simplifyDate(raw);
      cell.textContent = simple;
      const td = document.createElement("td");
      td.textContent = daysLeftText(simple);
      row.appendChild(td);
    });
  }
}

window.addEventListener("load", () => {
  const observer = new MutationObserver(() => {
    const table = document.getElementById("dataTable");
    if (table && table.rows.length > 1) {
      observer.disconnect();
      insertRemainingDays();
    }
  });
  observer.observe(document.body, { childList: true, subtree: true });
});
</script>

</body>
</html>
