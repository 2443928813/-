
function simplifyDate(iso) {
  return iso.includes("T") ? iso.split("T")[0] : iso;
}

function daysLeftText(dateStr) {
  const today = new Date();
  const target = new Date(dateStr);
  const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
  if (isNaN(diff)) return "";
  return diff >= 0 ? `باقي ${diff} يوم` : `منتهي منذ ${Math.abs(diff)} يوم`;
}

function insertRemainingDays() {
  const table = document.getElementById("dataTable");
  if (!table) return;

  const headerRow = table.rows[0];
  const labelMap = {
    "تاريخ انتهاء الإقامة": "الأيام المتبقية للإقامة",
    "تاريخ انتهاء العقد": "الأيام المتبقية للعقد",
    "تاريخ الانتهاء": "الأيام المتبقية",
    "تاريخ انتهاء الاستمارة": "الأيام المتبقية للاستمارة",
    "تاريخ انتهاء التأمين": "الأيام المتبقية للتأمين"
  };

  const dateIndexes = {};

  for (let i = 0; i < headerRow.cells.length; i++) {
    const label = headerRow.cells[i].textContent.trim();
    if (labelMap[label]) {
      dateIndexes[i] = labelMap[label];
    }
  }

  // أضف الأعمدة الجديدة للعناوين
  Object.values(dateIndexes).forEach(label => {
    const th = document.createElement("th");
    th.textContent = label;
    headerRow.appendChild(th);
  });

  for (let i = 1; i < table.rows.length; i++) {
    const row = table.rows[i];
    Object.keys(dateIndexes).forEach(index => {
      const cell = row.cells[index];
      const raw = cell.textContent.trim();
      const simple = simplifyDate(raw);
      cell.textContent = simple;
      const td = document.createElement("td");
      td.textContent = daysLeftText(simple);
      row.appendChild(td);
    });
  }
}

window.addEventListener("load", () => {
  const observer = new MutationObserver(() => {
    const table = document.getElementById("dataTable");
    if (table && table.rows.length > 1) {
      observer.disconnect();
      insertRemainingDays();
    }
  });
  observer.observe(document.body, { childList: true, subtree: true });
});
</script>

</body>
</html>
